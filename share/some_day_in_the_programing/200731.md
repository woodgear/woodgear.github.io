---
time: '2020-07-31T23:42:21+08:00'
id: '5dde054'
---

tinykv中在[`opts.DB.IngestExternalFiles(externalFiles)`](https://github.com/pingcap-incubator/tinykv/blob/2cf41a814468aae405ba860f30fb2ccfc5cc9aad/kv/raftstore/snap/snap.go#L692) 一直卡住 最终追查到[badger](https://github.com/Connor1996/badger/blob/9bbcbd8ba570f09f3f2f395b11a6385a14750237/db.go#L913)发现是` directio.OpenFile`使用`O_DIRECT`flag的问题.确定了原因之后找原理就轻松多了.参照[使用go语言绕过page cache读写文件](https://www.cnblogs.com/renjiashuo/p/7426592.html)

## update 2020-08-03 10:09:24
更加本质的原因是/tmp 目录是tmpfs 而tmpfs本身好像就不是很支持directio  
等价性验证: `dd if=/dev/zero of=/tmp/myfile bs=1M count=1 oflag=direct`  
同样也会报错`dd: failed to open '/tmp/myfile': Invalid argument`

提了个[issue](https://github.com/ncw/directio/issues/9)