<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.44 'Fira Sans',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Fira Sans',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;color:hsla(0,0%,0%,1);font-family:'Playfair Display',serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2.15rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;color:hsla(0,0%,0%,1);font-family:'Playfair Display',serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.58293rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;color:hsla(0,0%,0%,1);font-family:'Playfair Display',serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.35824rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;color:hsla(0,0%,0%,1);font-family:'Playfair Display',serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;color:hsla(0,0%,0%,1);font-family:'Playfair Display',serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.85805rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;color:hsla(0,0%,0%,1);font-family:'Playfair Display',serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.79482rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}ul{margin-left:1.44rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.44rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;font-size:0.85rem;line-height:1.44rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;font-size:1rem;line-height:1.44rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}blockquote{margin-left:0;margin-right:1.44rem;margin-top:0;padding-bottom:0;padding-left:1.17rem;padding-right:0;padding-top:0;margin-bottom:1.08rem;font-size:1.16543rem;line-height:1.44rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.27rem solid hsla(0,0%,0%,0.2);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.08rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.08rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.08rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.44rem;margin-bottom:calc(1.08rem / 2);margin-top:calc(1.08rem / 2);}li > ul{margin-left:1.44rem;margin-bottom:calc(1.08rem / 2);margin-top:calc(1.08rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.08rem / 2);}code{font-size:0.85rem;line-height:1.44rem;}kbd{font-size:0.85rem;line-height:1.44rem;}samp{font-size:0.85rem;line-height:1.44rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:0.96rem;padding-right:0.96rem;padding-top:0.72rem;padding-bottom:calc(0.72rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#9f392b;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.44rem;color:hsla(0,0%,0%,0.8);font-weight:400;}blockquote cite:before{content:"— ";}@media only screen and (max-width:480px){blockquote{margin-left:-1.08rem;margin-right:0;padding-left:0.81rem;}}</style><style data-href="/styles.6ca86b1026e5089e242c.css">html{background-color:#f5f5f5}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.4.2"/><link href="//fonts.googleapis.com/css?family=Playfair+Display:700|Fira+Sans:400,400i,700,700i" rel="stylesheet" type="text/css"/><link as="script" rel="preload" href="/webpack-runtime-f2dfeaa1ac279a516165.js"/><link as="script" rel="preload" href="/styles-7216303f3e7f86957a4d.js"/><link as="script" rel="preload" href="/app-b20866317a2cdfbe1c50.js"/><link as="script" rel="preload" href="/0-cfddba1340489db662f8.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-ce1cd232eaea3ce21b72.js"/><link as="fetch" rel="preload" href="/static/d/624/path---talk-how-it-work-actix-actix-0-c-4-c31-o5Y5WKJIZVPBOIKM9feMmmXeso.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><style data-emotion-css="mqm3rl">.css-mqm3rl{margin:0 auto;max-width:700px;padding:0.72rem;padding-top:2.16rem;}</style><div class="css-mqm3rl"><a href="/"><style data-emotion-css="i0b9uu">.css-i0b9uu{margin-bottom:2.88rem;display:inline-block;font-style:normal;}</style><h3 class="css-i0b9uu">Exist&amp;Change</h3></a><div><h1></h1><div><h1>为什么能够通过addres 来send msg</h1>
<p>contextimpl 中的poll中执行力self.mailbox.poll(self,act) 其中一直在读msg然后执行msg的handle方法 实际上就接收到了Msg
每个addres 通过Arc共享一份内存一直在push msg</p>
<h1>AddressSenderProducter的Send方法在做什么?</h1>
<p>递增num_senders并构造AddressSender
只不过多线程问题 所以用了原子类型操作而已</p>
<h1>task current 在做什么</h1>
<p>目前acti使用的时future 1.0 + tokio 1.x 并没有搞懂里面具体的逻辑 不过大意就是获得了一个当前线程的waker 以便在后面通过notify通知到对应的actor 可以参照 <a href="../aync_book">rust async book</a>中的例子就懂了</p>
<h1>当Actor启动时发生了什么</h1>
<p>如actix.pdf</p>
<h1>当我们在Handle Msg 时通过ctx 自己给自己notify 一个msg时 我们做了什么</h1>
<p>类似于此的函数实质就是直接调用spawn</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust">    <span class="token comment">/// Sends the message `msg` to self.</span>
    <span class="token keyword">fn</span> notify<span class="token operator">&lt;</span>M<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> M<span class="token punctuation">)</span>
    <span class="token keyword">where</span>
        A<span class="token punctuation">:</span> Handler<span class="token operator">&lt;</span>M<span class="token operator">></span><span class="token punctuation">,</span>
        M<span class="token punctuation">:</span> Message <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ActorState<span class="token punctuation">:</span><span class="token punctuation">:</span>Stopped <span class="token punctuation">{</span>
            <span class="token function">error!</span><span class="token punctuation">(</span><span class="token string">"Context::notify called for stopped actor."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>ActorMessageItem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> notify_later<span class="token operator">&lt;</span>M<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> M<span class="token punctuation">,</span> after<span class="token punctuation">:</span> Duration<span class="token punctuation">)</span> <span class="token punctuation">-></span> SpawnHandle
    <span class="token keyword">where</span>
        A<span class="token punctuation">:</span> Handler<span class="token operator">&lt;</span>M<span class="token operator">></span><span class="token punctuation">,</span>
        M<span class="token punctuation">:</span> Message <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ActorState<span class="token punctuation">:</span><span class="token punctuation">:</span>Stopped <span class="token punctuation">{</span>
            <span class="token function">error!</span><span class="token punctuation">(</span><span class="token string">"Context::notify_later called for stopped actor."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            SpawnHandle<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>ActorDelayedMessageItem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> run_later<span class="token operator">&lt;</span>F<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> dur<span class="token punctuation">:</span> Duration<span class="token punctuation">,</span> f<span class="token punctuation">:</span> F<span class="token punctuation">)</span> <span class="token punctuation">-></span> SpawnHandle
    <span class="token keyword">where</span>
        F<span class="token punctuation">:</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> A<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> A<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>TimerFunc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>dur<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Spawns a job to execute the given closure periodically, at a</span>
    <span class="token comment">/// specified fixed interval.</span>
    <span class="token keyword">fn</span> run_interval<span class="token operator">&lt;</span>F<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> dur<span class="token punctuation">:</span> Duration<span class="token punctuation">,</span> f<span class="token punctuation">:</span> F<span class="token punctuation">)</span> <span class="token punctuation">-></span> SpawnHandle
    <span class="token keyword">where</span>
        F<span class="token punctuation">:</span> <span class="token function">FnMut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> A<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> A<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>IntervalFunc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>dur<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>至于spawn 本身则是将这个这个future丢到了contextimpl的items中可以参见ContextFut的poll 这里又去poll了self.items实际上就是执行了一下这些fututre</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust">    <span class="token attribute attr-name">#[inline]</span>
    <span class="token comment">/// Spawn new future to this context.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> spawn<span class="token operator">&lt;</span>F<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> fut<span class="token punctuation">:</span> F<span class="token punctuation">)</span> <span class="token punctuation">-></span> SpawnHandle
    <span class="token keyword">where</span>
        F<span class="token punctuation">:</span> ActorFuture<span class="token operator">&lt;</span>Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Actor <span class="token operator">=</span> A<span class="token operator">></span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>handles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>handles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle<span class="token punctuation">;</span>
        <span class="token keyword">let</span> fut<span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>ActorFuture<span class="token operator">&lt;</span>Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Actor <span class="token operator">=</span> A<span class="token operator">>></span> <span class="token operator">=</span> Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>fut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> fut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handle
    <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h1>当我们获得一个actor的address 并通过这个address send一个msg时 我们做了什么</h1>
<p>每一个Actor的address实际上共享一个队列 send msg 时实际上就是将msg丢到Actor的message_queue中并且去notify这个Actor</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> AddressSender<span class="token operator">&lt;</span>A<span class="token punctuation">:</span> Actor<span class="token operator">></span> <span class="token punctuation">{</span>
    inner<span class="token punctuation">:</span> Arc<span class="token operator">&lt;</span>Inner<span class="token operator">&lt;</span>A<span class="token operator">>></span><span class="token punctuation">,</span>
    <span class="token comment">// 省略</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>A<span class="token punctuation">:</span> Actor<span class="token operator">></span> AddressSender<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> send<span class="token operator">&lt;</span>M<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> M<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>Receiver<span class="token operator">&lt;</span>M<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">></span><span class="token punctuation">,</span> SendError<span class="token operator">&lt;</span>M<span class="token operator">>></span>
    <span class="token keyword">where</span>
        A<span class="token punctuation">:</span> Handler<span class="token operator">&lt;</span>M<span class="token operator">></span><span class="token punctuation">,</span>
        A<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">:</span> ToEnvelope<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> M<span class="token operator">></span><span class="token punctuation">,</span>
        M<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token punctuation">:</span> Send<span class="token punctuation">,</span>
        M<span class="token punctuation">:</span> Message <span class="token operator">+</span> Send<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">poll_unparked</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span>SendError<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Full</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> park_self <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">inc_num_messages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Some</span><span class="token punctuation">(</span>park_self<span class="token punctuation">)</span> <span class="token operator">=></span> park_self<span class="token punctuation">,</span>
            None <span class="token operator">=></span> <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span>SendError<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Closed</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> park_self <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">sync_channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> env <span class="token operator">=</span> <span class="token operator">&lt;</span>A<span class="token punctuation">:</span><span class="token punctuation">:</span>Context <span class="token keyword">as</span> ToEnvelope<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> M<span class="token operator">>></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">pack</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">queue_push_and_signal</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>rx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function">queue_push_and_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> Envelope<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span>message_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fn</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> recv_task <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span>recv_task<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> recv_task<span class="token punctuation">.</span>unparked <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            recv_task<span class="token punctuation">.</span>unparked <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
            recv_task<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token operator">=</span> task <span class="token punctuation">{</span>
            task<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>剩下的问题就是address是怎么来的</p>
<ol>
<li>Actor启动时返回的Address</li>
</ol>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span>A<span class="token operator">></span> Context<span class="token operator">&lt;</span>A<span class="token operator">></span>
<span class="token keyword">where</span>
    A<span class="token punctuation">:</span> Actor<span class="token operator">&lt;</span>Context <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Context<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> mb <span class="token operator">=</span> Mailbox<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Context <span class="token punctuation">{</span>
            parts<span class="token punctuation">:</span> ContextParts<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>mb<span class="token punctuation">.</span><span class="token function">sender_producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mb<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>mb<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> act<span class="token punctuation">:</span> A<span class="token punctuation">)</span> <span class="token punctuation">-></span> Addr<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> fut <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">into_future</span><span class="token punctuation">(</span>act<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> addr <span class="token operator">=</span> fut<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Arbiter<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span>fut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        addr
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>A<span class="token punctuation">,</span> C<span class="token operator">></span> ContextFut<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> C<span class="token operator">></span>
<span class="token keyword">where</span>
    C<span class="token punctuation">:</span> AsyncContextParts<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">,</span>
    A<span class="token punctuation">:</span> Actor<span class="token operator">&lt;</span>Context <span class="token operator">=</span> C<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
        <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Addr<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>mailbox<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>A<span class="token operator">></span> Mailbox<span class="token operator">&lt;</span>A<span class="token operator">></span>
<span class="token keyword">where</span>
    A<span class="token punctuation">:</span> Actor<span class="token punctuation">,</span>
    A<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">:</span> AsyncContext<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Addr<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
        Addr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>msgs<span class="token punctuation">.</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>问题就是MailBox的msgs到底是什么</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span>A<span class="token operator">></span> Default <span class="token keyword">for</span> Mailbox<span class="token operator">&lt;</span>A<span class="token operator">></span>
<span class="token keyword">where</span>
    A<span class="token punctuation">:</span> Actor<span class="token punctuation">,</span>
    A<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">:</span> AsyncContext<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">fn</span> <span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> channel<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">channel</span><span class="token punctuation">(</span>DEFAULT_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Mailbox <span class="token punctuation">{</span> msgs<span class="token punctuation">:</span> rx <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>channel又是一个很麻烦的东西</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> channel<span class="token operator">&lt;</span>A<span class="token punctuation">:</span> Actor<span class="token operator">></span><span class="token punctuation">(</span>buffer<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>AddressSender<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">,</span> AddressReceiver<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check that the requested buffer size does not exceed the maximum buffer</span>
    <span class="token comment">// size permitted by the system.</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>buffer <span class="token operator">&lt;</span> MAX_BUFFER<span class="token punctuation">,</span> <span class="token string">"requested buffer size too large"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> inner <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Inner <span class="token punctuation">{</span>
        buffer<span class="token punctuation">:</span> AtomicUsize<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
        state<span class="token punctuation">:</span> AtomicUsize<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>INIT_STATE<span class="token punctuation">)</span><span class="token punctuation">,</span>
        message_queue<span class="token punctuation">:</span> Queue<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        parked_queue<span class="token punctuation">:</span> Queue<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        num_senders<span class="token punctuation">:</span> AtomicUsize<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        recv_task<span class="token punctuation">:</span> Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>ReceiverTask <span class="token punctuation">{</span>
            unparked<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
            task<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> tx <span class="token operator">=</span> AddressSender <span class="token punctuation">{</span>
        inner<span class="token punctuation">:</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inner<span class="token punctuation">)</span><span class="token punctuation">,</span>
        sender_task<span class="token punctuation">:</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>SenderTask<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        maybe_parked<span class="token punctuation">:</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>AtomicBool<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> rx <span class="token operator">=</span> AddressReceiver <span class="token punctuation">{</span> inner <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> rx<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>在这里我们可以看到Inner终于被创建出来的 下面的无论是sender 还是sender_producer 实质上使用的都是同一份inner 也就是说通过Actor的address() 就能够将Msg丢到Actor的MailBox中这样在Actor被poll时他就会通过self.mailbox.poll()来调用真正的处理函数</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span>A<span class="token punctuation">:</span> Actor<span class="token operator">></span> AddressReceiver<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">sender</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> AddressSender<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment">// this code same as Sender::clone</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> curr <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span>num_senders<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>SeqCst<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token comment">// If the maximum number of senders has been reached, then fail</span>
            <span class="token keyword">if</span> curr <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">max_senders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"cannot clone `Sender` -- too many outstanding senders"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">let</span> next <span class="token operator">=</span> curr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> actual <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span>num_senders<span class="token punctuation">.</span><span class="token function">compare_and_swap</span><span class="token punctuation">(</span>curr<span class="token punctuation">,</span> next<span class="token punctuation">,</span> SeqCst<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// The ABA problem doesn't matter here. We only care that the</span>
            <span class="token comment">// number of senders never exceeds the maximum.</span>
            <span class="token keyword">if</span> actual <span class="token operator">==</span> curr <span class="token punctuation">{</span>
                <span class="token keyword">return</span> AddressSender <span class="token punctuation">{</span>
                    inner<span class="token punctuation">:</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sender_task<span class="token punctuation">:</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>SenderTask<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    maybe_parked<span class="token punctuation">:</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>AtomicBool<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            curr <span class="token operator">=</span> actual<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Creates the sender producer.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">sender_producer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> AddressSenderProducer<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
        AddressSenderProducer <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
## ReceiverTask 中的task什么时候被设置进去的
初始化时为none在AddressReceiver被poll时 <span class="token punctuation">(</span>mailbox被poll时<span class="token punctuation">)</span> 的try_park中被设置
也就是在Actor第一次被Poll时设置 也就是Arbiter<span class="token punctuation">:</span><span class="token punctuation">:</span>spawn时被设置
```rust
<span class="token keyword">impl</span><span class="token operator">&lt;</span>A<span class="token punctuation">:</span> Actor<span class="token operator">></span> Stream <span class="token keyword">for</span> AddressReceiver<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item <span class="token operator">=</span> Envelope<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Poll<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Item<span class="token operator">></span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token comment">// Try to read a message off of the message queue.</span>
            <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">next_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Async<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ready</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">=></span> msg<span class="token punctuation">,</span>
                Async<span class="token punctuation">:</span><span class="token punctuation">:</span>NotReady <span class="token operator">=></span> <span class="token punctuation">{</span>
                    <span class="token comment">// There are no messages to read, in this case, attempt to</span>
                    <span class="token comment">// park. The act of parking will verify that the channel is</span>
                    <span class="token comment">// still empty after the park operation has completed.</span>
                    <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">try_park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        TryPark<span class="token punctuation">:</span><span class="token punctuation">:</span>Parked <span class="token operator">=></span> <span class="token punctuation">{</span>
                            <span class="token comment">// The task was parked, and the channel is still</span>
                            <span class="token comment">// empty, return NotReady.</span>
                            <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">:</span><span class="token punctuation">:</span>NotReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        TryPark<span class="token punctuation">:</span><span class="token punctuation">:</span>NotEmpty <span class="token operator">=></span> <span class="token punctuation">{</span>
                            <span class="token comment">// A message has been sent while attempting to</span>
                            <span class="token comment">// park. Loop again, the next iteration is</span>
                            <span class="token comment">// guaranteed to get the message.</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token comment">// If there are any parked task handles in the parked queue, pop</span>
            <span class="token comment">// one and unpark it.</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">unpark_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Decrement number of messages</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">dec_num_messages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Return the message</span>
            <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Ready</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>A<span class="token punctuation">:</span> Actor<span class="token operator">></span> AddressReceiver<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">try_park</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> TryPark <span class="token punctuation">{</span>
        <span class="token comment">// First, track the task in the `recv_task` slot</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> recv_task <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span>recv_task<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> recv_task<span class="token punctuation">.</span>unparked <span class="token punctuation">{</span>
            <span class="token comment">// Consume the `unpark` signal without actually parking</span>
            recv_task<span class="token punctuation">.</span>unparked <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> TryPark<span class="token punctuation">:</span><span class="token punctuation">:</span>NotEmpty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        recv_task<span class="token punctuation">.</span>task <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TryPark<span class="token punctuation">:</span><span class="token punctuation">:</span>Parked
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>至此一切就已经联系起来了
当我们向adr中send msg 时实际上在向这个Actor的mailbox中的message_queue中推Envelope </p>
<p>并且notify下Actor的Task因为Actor的第一次被poll就会设置task所以send了一个msg时能够找到Actor的task并去notify他</p>
<h1>为什么Actor启动必须要System?</h1>
<h1>Service 是如何工作的</h1>
<h1>如何将Actor启动在不同的线程中</h1>
<h1>当某个Actor阻塞时 之前在其中设置的Timer会有什么样的表现行为 为什么</h1></div></div><div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"talk-how-it-work-actix-actix-0c4","path":"/talk/how-it-work/actix/actix/"};window.dataPath="624/path---talk-how-it-work-actix-actix-0-c-4-c31-o5Y5WKJIZVPBOIKM9feMmmXeso";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-b20866317a2cdfbe1c50.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-ce1cd232eaea3ce21b72.js"],"component---src-pages-index-js":["/component---src-pages-index-js-41eb57ca3b9a91bdfb13.js"],"pages-manifest":["/pages-manifest-8f6e6a6e7f51dcbf3d63.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-ce1cd232eaea3ce21b72.js" async=""></script><script src="/0-cfddba1340489db662f8.js" async=""></script><script src="/app-b20866317a2cdfbe1c50.js" async=""></script><script src="/styles-7216303f3e7f86957a4d.js" async=""></script><script src="/webpack-runtime-f2dfeaa1ac279a516165.js" async=""></script></body></html>