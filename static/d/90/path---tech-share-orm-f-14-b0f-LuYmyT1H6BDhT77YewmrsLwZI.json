{"data":{"markdownRemark":{"html":"<h1>what a orm should be</h1>\n<ol>\n<li>define table</li>\n<li>insert</li>\n<li>query</li>\n<li>删除约束</li>\n<li>migrate</li>\n</ol>\n<h1>python</h1>\n<h2>pydal</h2>\n<h3>define table</h3>\n<p><a href=\"http://www.web2py.com/books/default/chapter/29/06/the-database-abstraction-layer\">doc</a></p>\n<p>构造出DAL对象后可以直接通过此对象定义table和访问表格中的数据</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">self<span class=\"token punctuation\">.</span>db <span class=\"token operator\">=</span> DAL<span class=\"token punctuation\">(</span>sqlite_uri<span class=\"token punctuation\">,</span> folder<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>folder_path<span class=\"token punctuation\">)</span>\nself<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span>define_table<span class=\"token punctuation\">(</span><span class=\"token string\">'word'</span><span class=\"token punctuation\">,</span> Field<span class=\"token punctuation\">(</span><span class=\"token string\">'user_id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Field<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'word'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Field<span class=\"token punctuation\">(</span><span class=\"token string\">'word_type'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Field<span class=\"token punctuation\">(</span><span class=\"token string\">'time'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nself<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 直接使用</span>\n <span class=\"token punctuation\">[</span>item<span class=\"token punctuation\">.</span>word <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span>word<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">==</span> <span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span>word<span class=\"token punctuation\">.</span>word_type <span class=\"token operator\">==</span> <span class=\"token string\">\"unknow\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>select<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span>word<span class=\"token punctuation\">.</span>ALL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过定义Field对象来描述field (类型约束之类的)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">Field<span class=\"token punctuation\">(</span>fieldname<span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span> length<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span>DEFAULT<span class=\"token punctuation\">,</span>\n      required<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> requires<span class=\"token operator\">=</span>DEFAULT<span class=\"token punctuation\">,</span>\n      ondelete<span class=\"token operator\">=</span><span class=\"token string\">'CASCADE'</span><span class=\"token punctuation\">,</span> notnull<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> unique<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n      uploadfield<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> widget<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> label<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>\n      writable<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> readable<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> searchable<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> listable<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n      update<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> authorize<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> autodelete<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> represent<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>\n      uploadfolder<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> uploadseparate<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> uploadfs<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>\n      compute<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> filter_in<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> filter_out<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>\n      custom_qualifier<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> map_none<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> rname<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>insert</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">cropus_id = self.db.corpus_meta.insert(**corpus_meta_data)</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h3>约束</h3>\n<p>通过在Field中设置reference属性</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">db<span class=\"token punctuation\">.</span>define_table<span class=\"token punctuation\">(</span><span class=\"token string\">\"user_corpus\"</span><span class=\"token punctuation\">,</span>\n                Field<span class=\"token punctuation\">(</span><span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"string\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                Field<span class=\"token punctuation\">(</span><span class=\"token string\">\"corpus_id\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"reference corpus_meta\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>额外的事</h2>\n<p>pydal 会为每个表自动创建一个自增主键id 可以通过在定义时知名type='id'来将某个field设为自增主键(但是pydal的作者并不推荐)</p>","fields":{"slug":"/tech-share/orm/","disqus":{"shortname":"woodgear-blog"}},"frontmatter":{"id":"xfq7njk","time":"1996-09-08T23:37:07+08:00","tag":null},"parent":{"__typename":"File","name":"orm","ext":".md","birthTime":"1970-01-01T00:00:00.000Z","changeTime":"2020-11-26T15:07:13.989Z","relativeDirectory":"tech-share","absolutePath":"/home/oaa/ns/share/blog/tech-share/orm.md"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/tech-share/orm/","disqus":{"shortname":"woodgear-blog"}}}